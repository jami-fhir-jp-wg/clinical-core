<style type="text/css">

table {
  border: solid 1px black;
  border-collapse: collapse;
}
 
table td {
  border: solid 1px black;

}

table th {
  border: solid 1px black;
}
   h1 {
      counter-reset: chapter;
    }

    h2 {
      counter-reset: sub-chapter;
    }

    h3 {
      counter-reset: section;
    }

    h4 {
      counter-reset: sub-section;
    }

    h5 {
      counter-reset: composite;
    }

    h6 {
      counter-reset: sub-composite;
    }

    h1:before {
      color: black;
      counter-increment: bchapter;
      content:  " ";
    }

    h2:before {
      color: black;
      counter-increment: chapter;
      content: counter(chapter) ". ";
    }

    h3:before {
      color: black;
      counter-increment: sub-chapter;
      content: counter(chapter) "."counter(sub-chapter) ". ";
    }


    h4:before {
      color: black;
      counter-increment: section;
      content: counter(chapter) "."counter(sub-chapter) "."counter(section) " ";
    }

    h5:before {
      color: black;
      counter-increment: sub-section;
      content: counter(chapter) "."counter(sub-chapter) "."counter(section) "."counter(sub-section) " ";
    }

    h6:before {
      color: black;
      counter-increment: sub-sub-section;
      content: "　　"counter(sub-sub-section) "）";
    }

</style>




# 電子カルテ情報共有サービス（仮称）に医療機関から送信するFHIR仕様について

## Push送信時の複数リソースデータのまとめ方
### Bundleリソース（collectionタイプ）の使用
電子カルテ情報共有サービス（仮称）に医療機関から送信する場合、１回に送信するリソースデータは、複数リソースタイプの複数リソースデータから構成されるのが普通である。FHIRではこのような送受信のまめに、異なるリソースタイプの複数リソースデータをひとまりにしたひとつのリソースとしてBundleリソースタイプが用意されている。<br>
電子カルテ情報共有サービス（仮称）に医療機関から送信する場合には、このBundleリソースタイプのひとつのリソースデータにして１回の送信で送信する。なお、1回で送信するひとつのBundleリソースには、ひとつのリソースデータを格納してもよいし、複数のリソースデータを格納してもよい。また、1回で送信するひとつのBundleリソースには、6情報のうち複数の情報種別、複数のリソースタイプのデータを格納してもよい。

ただし、電子カルテ情報共有サービス（仮称）で処理対象となっていないリソースの情報は処理されず破棄される（エラーとはならない）。

Bundleリソースのタイプ（type要素）は"collection"を使用する。<br>
なおひとつのBundlleに格納されるリソースデータ（以下の例では、Observation）同士を参照する（一方のリソースデータから同じBundle内の他のリソースを参照する）ことはできない。<br>
従って、たとえばひとつのBundlleに検査結果Observationリソースと、患者Patientリソースを別々のentryに格納して、Observationリソース側から検査結果の対象患者をそのPatientリソースをReferenceする方式で指し示すことはできない。

BundleリソースのIdentifier要素は、電子カルテ情報共有サービス（仮称）側では保存されないので、このIdentifierを指定して後続の送信において、以前に送信したBundleリソース内の全データについて削除、更新などの処理を期待することはできない。

Bundleリソース・インスタンスの例（JSON形式）：
```
{
    "resourceType": "Bundle",
    "id": "Bundle-for-Example01",
    "meta": {
        :
        <省略>
        :
    },
    "identifier": {
        :
        <省略>
        :
    },
    "type": "collection",
    "timestamp": "2020-08-21T12:12:21+09:00",
    "entry": [
        {
            "fullUrl": "urn:uuid:6050a046-8f36-5064-c231-3aeacbc0c886",
            "resource": {
                "resourceType": "Observation",
                "id": "JP-Observation-Example001",
                :
                <１個目の検査結果><省略>
                :
            }
        },
        {
            "fullUrl": "urn:uuid:0c83b8af-ba92-5c73-e84e-c719f232cc61",
            "resource": {
                "resourceType": "Observation",
                "id": "JP-Observation-Example001",
                :
                <２個目の検査結果><省略>
                :
            }
        },
        {
            "fullUrl": "0dc2fb4c-baf1-4a30-0df4-58de94f34d2f",
            "resource": {
                "resourceType": "Observation",
                "id": "JP-Observation-Example001",
                :
                <３個目の検査結果><省略>
                :
            }
        }
    ]
}
```

<br>

### Bundle内のentryの識別子
Bundle.entry[] に繰り返しで格納される個々のリソース・インスタンスは、必ずBundle.entry[].fullUrl要素に、uuidをその都度毎回生成して設定しなければならない。同じリソースインスタンスを別のBundleリソースにより再送する場合でも、前回使用したuuidを使用しないものとするが、受信側ではチェックしないためこれに違反してもエラーにはならない。
1回で送信したひとつのBundleインスタンスの中に同一のuuidが存在してはならず、これに違反した場合には受信側からエラーが戻される。

このuuidによるBundle内のentryの識別子を、前回送信時の特定のentryの内容を受信側に指し示すための識別子として利用することはできない。

<br>

## FHIRリソース・インスタンスを指定する識別子について
６情報として送信し受理されたFHIRリソースインスタンスを対象にして、次回以降の送信時に削除、更新などの処理を行いたい場合に、対象となる特定のFHIRリソース・インスタンスを指定する方法を説明する。

概要：　リソース・インスタンスのidentifier要素により、送信済みのリソース・インスタンスを処理対象として指定する。
指定方法：対象リソースタイプと、そのidentifier要素のsystem値とvalue値のペア

ただし、正しく対象リソース・インスタンスを指定できるようにするため、送信側は、identifier要素のsystem値とvalue値は以下のどちらかのルールに従って設定しなければならない。
1. 送信するリソース・インスタンスを、あとでいつでもその唯一のリソース・インスタンスを一意に識別できるように、identifier要素が設定されている。すなわち、identifier要素のsystem値とvalue値のペア、およびリソースタイプを指定すれば、いつでも受信側がそれをキーとして保持していれば、ただひとつ特定できるように、identifier要素が設定されている。
1. 送信済みのリソース・インスタンスには、常に同時に削除処理されて新規登録される限りは問題が生じないような同一のidentifier要素値が設定されているひとつまたは複数のリソース・インスタンスが存在する。

このルールの意味を理解するために、受信側のサービスの処理を先に説明する。

### 電子カルテ情報共有サービス（仮称）での処理内容：
  - 削除処理要求された場合：<br>
    削除処理時に受信したBundleリソースに含まれる個々のリソースインスタンスについて、そのリソースタイプと、identifier要素のsystem値が""とvalue値の両方がすべて一致するidentifierを１組だけ持つFHIRリソースインスタンスをすべて検索して、その全てのFHIRリソースインスタンスに対して指定された削除処理を行なう。
    <br>削除処理の途中で失敗した対象があった場合には、この処理すべて（今回の削除処理すべて）を中止し、削除処理の前の状態に戻る（ロールバック）。
  - 更新処理の場合には、削除＋新規登録の処理を行うことによって更新処理を実現する。すなわち、上記の方法で該当した全てのFHIRリソースインスタンスを削除したのちに、送信されたFHIRリソースインスタンスを新規に書き込むことによって行なう。
  <br>この際、送信されたFHIRリソースインスタンスのなかに、更新処理対象として指定されたidentifier要素のsystem値とvalue値のペアと完全一致しない場合ものがひとつでもある場合には、不正な更新依頼とみなし、この処理すべて（削除＋更新のうちの削除を含むすべての処理）を中止し、削除＋更新の処理前の状態に戻る（ロールバック）。<br>指定された対象となる既存のFHIRリソースインスタンスと比べて更新データに過不足があっても構わない。
<br>
以上の要件を満たすため、６情報の各リソースインスタンスには、この仕様で対象となるリソースインスタンスを指定できるように、送信側の責任で適切にidentifier要素のsystem値とvalue値とを設定すること。
特に以下の点に留意すること。
 - １回のオーダで複数の処方薬、複数の検査結果項目が発生して、複数のリソースインスタンスを１回のBundleで送信した場合に、これらのリソースインスタンスひとつひとつを個別に異なるインスタンスとして識別できる粒度のidentifierを、送信する側が割り当てることができ、その後の更新や削除の指示においても、１回目に送信したときと同じそれぞれのidentifierを指定して削除や更新の処理依頼が出せるシステムであれば、（すなわち２回目以降の処理依頼において対象指定するidentifierが、１回目のidentifierが指し示すインスタンスと変わりなく同じインスタンスを指し示すことができるのであれば、）そのidentifierを用いる仕様で差し支えない。
 - １回のオーダで複数の処方薬、複数の検査結果項目が発生して、複数のリソースインスタンスを１回のBunsleで送信した場合に、これらの複数のリソースインスタンスにすべて（オーダ番号のような）同じidentifierが送信する側で割り当てられるシステムの場合には、そのidentifierを用いる仕様で差し支えないが、処理は常に１回のオーダの複数インスタンスがすべて対象となる。
 -  １回のオーダで複数の処方薬、複数の検査結果項目が発生して、複数のリソースインスタンスを１回のBunsleで送信した場合に、これらのリソースインスタンスひとつひとつを個別に異なるインスタンスとして識別できる粒度のidentifierを、送信する側が割り当てることができるが、その後の更新や削除の指示においては、１回目に送信したときと同じidentifierが２回目以降ではそのオーダ内の別のインスタンスを指し示す可能性があるシステムもありうる。<br>例えば、１回オーダに含まれる個々のインスタンスを区別するのに、オーダ内の出現順序番号を付与して作られたidentifierである場合などが、このケースである。<br>このようなシステムの場合には、１回のオーダごとに送信されるすべてのインスタンスにおいて同一のidentifierが割り当てられるように、送信する側で新たなidentifier（新たなsystem値を使って）を作成し、インスタンスに追加設定する必要がある。これを使って２回目以降の削除や更新処理対象を指定することが必要である。<br>

### 検体検査結果情報における検査項目のコーディング
いわゆる6情報のうち、検体検査結果情報は、Observationリソースタイプを使用し、Profile「診療情報コアサマリー用　Observationリソース（検体検査結果／感染症検体検査結果）プロファイル」に準拠してデータを作成するものとする。
検査項目を識別する情報は、code要素に設定される項目コード情報(code.coding要素)に、JLAC10コードまたはJLAC11コードのいずれか、またはそれに準拠した以降で説明するコードのいずれかの情報を必ず設定しなければならない。いずれも設定されていない場合には、エラーとして扱われる。

以下では「JLACコード」とは、JLAC10コードまたはJLAC11コードを指す。

#### 「コア検体検査項目リスト*」に掲載される検査項目の場合：

```
 * コア検体検査項目リスト : 別に厚生労働省が定める「6情報におけるコア検体検査項目リスト（仮称）」（43項目）
```
 - コア検体検査項目リストに掲載される当該項目の、同リストに掲載されているJLACコード
 - コア検体検査項目リスト掲載される当該項目の、同リストに掲載されているJLACコードから、測定法コード部分3桁を998（「測定法を問わず」の意味）に置き換えたコード：これは、測定法3桁のコーディングが正しくできない場合や、掲載されているコードと測定法が異なると考えられる場合に使用することができる。
この場合のsystem値は検体検査情報の説明を参照のこと。

##### 検査項目名称について
コードに対応する（code.coding[n].displayに設定する）項目名称は、コア検体検査項目リスト掲載される当該項目の、同リストに掲載されている項目名称の文字列をそのまま設定する必要がある。

#### 施設固有コードとその名称について
JLAC10コードの設定の有無に関わらず、施設固有コードとそれに対応する施設固有名称のペアは、上記コードを設定したcode.codingとは別のcode.codingに設定（code.coding.codeとcode.coding.displayに設定）することが必要である。
この場合のsystem値は"http://jpfhir.jp/fhir/eClinicalSummary/ValueSet/JP_CCS_ObsLabResult_LocalCode_CS"を固定で設定する。

#### 「コア検体検査項目リスト*」に掲載されない検査項目の場合：
 - 当該項目のJLACコード
 - 当該項目のJLACコードから、測定法コード部分3桁を998（「測定法を問わず」の意味）に置き換えたコード：これは、測定法3桁のコーディングが正しくできない場合に使用することができる。
 - 未標準化コード＝すべて9からなる17桁のコード（99999999999999999）：これは、なんらかの理由でJLACコードに対応づけられたデータを作成できない場合や、測定法以外の部分についても不正確である可能性が高い場合に、未標準化コードを表す意味で例外的に許容される。
この場合のsystem値は検体検査情報の説明を参照のこと。

##### 検査項目名称について
コードに対応する（code.coding[n].displayに設定する）項目名称は、JLACコードに対応する標準検査項目名称は定義されていないので、その項目を表す施設固有の名称文字列を適宜設定する。なお、未標準化コードに対応する名称は「未標準化コード項目(JLAC)」を

#### 施設固有コードとその名称について
JLAC10コード、未標準化コードの設定の有無に関わらず、施設固有コードとそれに対応する施設固有名称のペアは、上記コードを設定したcode.codingとは別のcode.codingに設定（code.coding.codeとcode.coding.displayに設定）することが必要である。
この場合のsystem値は"http://jpfhir.jp/fhir/eClinicalSummary/ValueSet/JP_CCS_ObsLabResult_LocalCode_CS"を固定で設定する。

### アレルギー情報と薬剤禁忌情報の区別
いわゆる6情報のうち、アレルギー情報と薬剤禁忌情報とは同じAllergyIntoleranceリソースタイプを使用し、同じProfile「診療情報コアサマリー用　AllergyIntoleranceリソース（アレルギー情報／薬剤禁忌）プロファイル」に準拠してデータを作成するものとし、両者の区別はAllergyIntoleranceリソースデータのcategory要素とcriticality要素に設定される値の組み合わせの違いにより以下の表に従い処理される。


薬剤禁忌情報においてはcategory要素にmedication、criticality要素にhighを必ず設定することによる。利用側（電子カルテ情報共有サービス（仮称））はこの両方の条件が満たされた場合にのみ「薬剤禁忌情報」として扱、どちらかまたは両方が満たされない場合には薬剤禁忌情報ではなくアレルギー情報として取り扱う。

|category要素|criticality要素|取り扱われる<br>6情報での種別|
|---|---|---|
|medication|high|薬剤禁忌情報。|
|medication|high以外|薬剤に対するアレルギー情報。<br>薬剤禁忌情報としては扱われない。|
|medication|値なし（要素なし）|薬剤に対するアレルギー情報。<br>薬剤禁忌としては扱われない。|
|medication以外|high|薬剤以外の原因物質に対するアレルギー情報。<br>薬剤禁忌としては扱われない。|
|medication以外|high以外|薬剤以外の原因物質に対するアレルギー情報。<br>薬剤禁忌としては扱われない。|
|medication以外|値なし（要素なし）|薬剤以外の原因物質に対するアレルギー情報。<br>薬剤禁忌としては扱われない。|
|値なし（要素なし）|値なし（要素なし）|なんらかのアレルギー情報。<br>薬剤禁忌としては扱われない。|

<br>

### 感染症情報とそれ以外の検体検査結果情報の区別
いわゆる6情報のうち、感染症情報とそれ以外の検体検査結果情報とは、同じObservationリソースタイプを使用し、同じProfile「診療情報コアサマリー用　Observationリソース（検体検査結果／感染症検体検査結果）プロファイル」に準拠してデータを作成するものとし、両者の区別はcode要素に設定される項目コード情報がJLAC10コードまたはJLAC11コードにより、
別に厚生労働省が定める「6情報における感染症検査項目リスト（仮称）」に含まれるコードである場合には、感染症情報として処理される。従って、感染症情報として検査情報を送信する場合には、必ず「6情報における感染症検査項目リスト（仮称）」に記載のJLAC10コードまたはJLAC11コードによりコーディングしなければならない。


<br>

### 保険個人識別子の格納
電子カルテ情報共有サービス（仮称）に医療機関から送信する場合には、個人識別子として、保険者情報と被保険者情報を送信することが必須である。このためFHIRリソースの患者情報であるPatientリソースのidentifier要素にこの識別子情報を設定しなければならない。<br>以下にその仕様を示す。<br>
なお、Patientリソースが、別のリソースに包含されるContainedリソースとなっているにもPatientリソースのidentifier要素にこの識別子情報を設定しなければならない。

##### 「保険個人識別子」の文字列仕様
個人識別子として、保険者情報と被保険者情報とを以下の仕様で連携した文字列を使用する。<br>
本仕様では、以下、これを「保険個人識別子」と称する。また英数字は１バイト系文字の英数字を指す。<br>
保険個人識別子:　以下の各情報（要素）を半角コロン（文字コード１６進数 5A）で結合する。<br>
要素を省略する、とある場合には、長さ０の文字列とする。<br>

 - 保険者等番号:　英数字８桁　保険者番号。８桁に満たない場合は、先頭に半角ゼロを追加して８桁とする。<br>
　　（保険者等番号とは、保険者番号または公費負担者番号を指す）<br><br>
 - 被保険者証（手帳）等の記号:　英数または全角文字。健康保険被保険者証、船員保険被保険者証、受給資格者票及び国民健康保険被保険者証等の「記号及び番号」欄の記号を記録する。全角だけからなる文字列または半角だけからなる文字列のどちらかとする。英数字だけの場合には 1 バイト系（半角）文字だけから構成するか、または全角文字だけから構成する。記号または仮名漢字を含む場合には、英数字を含めすべて全角文字だけから構成する。なお、いずれの場合にも、全角空白を含めないこととする。被保険者証（手帳）等の番号だけしかない場合には、本要素は省略する。<br><br>
 - 被保険者証（手帳）等の番号:　英数または全角文字。健康保険被保険者証、船員保険被保険者証、受給資格者票及び国民健康保険被保険者証等の「記号及び番号」欄の番号、または後期高齢者被保険者証の被保険者番号を記録する。全角だけからなる文字列または半角だけからなる文字列のどちらかとする。英数字だけの場合には 1 バイト系（半角）文字だけから構成するか、または全角文字だけから構成する。記号または仮名漢字を含む場合には、英数字を含めすべて全角文字だけから構成する。なお、いずれの場合にも、全角空白を含めないこととする。<br><br>
 - 被保険者証等枝番: 「被保険者証等枝番」に対応する文字列。半角数字2桁固定とする。枝番がない（表記されていない）場合には、00とするのではなく本要素は省略する。<br>
<br>
例）保険者等番号＝12345、被保険者証（手帳）等の記号＝あいう、被保険者証（手帳）等の番号＝１８７、枝番＝05 の場合、<br>
　　保険個人識別子＝ "00012345:あいう:１８７:05" となる。<br>
　被保険者証（手帳）等の記号と枝番がない場合には<br>
　　保険個人識別子＝ "00012345::１８７:" となる。この場合、最後のコロンは必須である。<br><br>

#### 保険個人識別子の格納方法
保険個人識別子は、Patientリソースのidentifier要素のvalueに記述する。この場合、system値には、「保険個人識別子」であることを示す「http:/jpfhir.jp/fhir/ccs/Idsysmem/JP_Insurance_member/保険者等番号８桁文字列」を設定する。
```
    {
      "resourceType": "Patient",
      "id": "Patient1",
        <省略>
      "identifier": [
        {
          "system": "urn:oid:1.2.392.100495.20.3.51.11234567890",
          "value": "12345"
        },
        {
          "system": "http:/jpfhir.jp/fhir/ccs/Idsysmem/JP_Insurance_member/00012345",
          "value": "00012345:あいう:１８７:05"
        }
      ],
      "name": [
        <省略>
```


### 長期保存の対象であることのフラグ情報の格納
電子カルテ情報共有サービス（仮称）に医療機関から送信する場合、送信するFHIRリソースが長期保存対象の情報である場合には、そのことを明示的に示すため、それぞれのリソース識別子情報を設定しなければならない。<br>以下にその仕様を示す。<br>

#### 長期保存情報の仕様
リソースのデータを長期保存対象とする場合には、そのリソースのデータにおけるmeta要素のtag要素に以下の形式で記述しなければならない。<br>
　meta.tag.system = "http:/jpfhir.jp/fhir/ccs/CodeSystem/JP_ehrexs_indication"　(この固定値とする)<br>
　meta.tag.code = "LTS"　(この固定値とする)<br>

```
{
  "resourceType": "AllergyIntolerance",
  "id": "Example-allergy",
  "meta": {
    :
    <省略>
    :
    "tag": {[
      {
        "system": "http:/jpfhir.jp/fhir/ccs/CodeSystem/JP_ehrexs_indication",
        "code": "LTS"
      }
    ]
    }

  },
```

### 病名情報における【未告知病名】であることのフラグ情報の格納
【未告知病名】とは、電子カルテ病名の登録済みの病名であるが、医療者がその病気の説明をまだ患者本人に対して病名やその病状を十分に説明していない段階であり、この病名情報を患者に提供する際には特別の配慮を必要とするものとして、電子カルテの病名登録画面上で、「未告知病名」として登録してある（または同様の意味あいのフラグを付与してある）病名情報のことである。
電子カルテ情報共有サービス（仮称）に医療機関からこの病名情報を送信する場合、送信する病名FHIRリソースにそのことを明示的に示すため、特別なリソース識別子情報を設定しなければならない。<br>以下にその仕様を示す。<br>

##### 【未告知病名】情報の仕様
病名リソース（Conditionリソース）におけるmeta要素のtag要素に以下の形式で記述しなければならない。<br>
　meta.tag.system = "http:/jpfhir.jp/fhir/ccs/CodeSystem/JP_ehrexs_indication"　(この固定値とする)<br>
　meta.tag.code = "UNINFORMED"　(この固定値とする)<br>

<br>


